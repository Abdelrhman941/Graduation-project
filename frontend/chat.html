<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - VirtAI</title>
    <meta name="description" content="Interact with your AI tutor through text and voice conversations.">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="assets/icon.ico">
</head>
<body class="chat-body">
    <!-- Settings Drawer -->
    <div class="settings-drawer" id="settings-drawer">
        <div class="drawer-overlay" onclick="closeSettings()"></div>
        <div class="drawer-content">
            <div class="drawer-header">
                <h2 class="drawer-title">Settings</h2>
                <button class="drawer-close" onclick="closeSettings()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <!-- Chat History Section -->
            <div class="drawer-section">
                <h3 class="drawer-section-title">
                    <i class="fa-solid fa-clock-rotate-left"></i> Chat History
                </h3>
                <div class="chat-history-list">
                    <div class="empty-state">
                        <i class="fa-solid fa-inbox" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 0.5rem;"></i>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">No chat history yet</p>
                    </div>
                </div>
            </div>
            
            <!-- Avatar Settings Section -->
            <div class="drawer-section">
                <h3 class="drawer-section-title">
                    <i class="fa-solid fa-user-circle"></i> Avatar Settings
                </h3>
                <div class="setting-item">
                    <label class="setting-label">AI Tutor Character</label>
                    <select class="setting-select" autocomplete="off">
                        <option>Prof. Emma</option>
                        <option>Teacher Alex</option>
                        <option>Dr. Sam</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label class="setting-label">Voice</label>
                    <select class="setting-select" autocomplete="off">
                        <option>Aria (Female, Friendly)</option>
                        <option>Nova (Female, Professional)</option>
                        <option>Alloy (Male, Neutral)</option>
                    </select>
                </div>
            </div>
            
            <!-- Document Settings Section -->
            <div class="drawer-section">
                <h3 class="drawer-section-title">
                    <i class="fa-solid fa-file-lines"></i> Document Settings
                </h3>
                <div class="setting-item">
                    <label class="setting-label">Knowledge Base</label>
                    <div class="doc-list">
                        <div class="empty-state">
                            <i class="fa-solid fa-folder-open" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 0.5rem;"></i>
                            <p style="color: var(--text-muted); font-size: 0.9rem;">No documents uploaded</p>
                        </div>
                    </div>
                </div>
                <input type="file" id="doc-upload" accept=".pdf,.docx,.txt" style="display: none;" onchange="handleDocumentUpload(event)" />
                <button class="setting-btn" onclick="document.getElementById('doc-upload').click()">
                    <i class="fa-solid fa-plus"></i> Add Document
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Notification -->
    <div class="notification-overlay" id="notification-overlay" onclick="closeNotification()">
        <div class="notification-box" onclick="event.stopPropagation()">
            <div class="notification-icon">
                <i class="fa-solid fa-exclamation-triangle"></i>
            </div>
            <div class="notification-content">
                <h3 class="notification-title">Connection Error</h3>
                <p class="notification-message" id="notification-message">Cannot send message: AI Tutor is offline. Please check your connection.</p>
            </div>
            <button class="notification-close" onclick="closeNotification()">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Main Split Screen Layout -->
    <div class="split-container">
        <!-- Left Panel: Avatar Interface -->
        <div class="avatar-panel">
            <!-- Avatar Image -->
            <img 
                src="https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?w=800&h=1200&fit=crop" 
                alt="AI Tutor" 
                class="avatar-image"
            />
            
            <!-- Settings Button (Top Left) -->
            <button class="avatar-settings-btn" onclick="openSettings()" title="Settings">
                <i class="fa-solid fa-gear"></i>
            </button>
            
            <!-- Status Badge (Top Right) -->
            <div class="avatar-status-badge" id="status-badge">
                <span class="status-dot"></span>
                <span id="status-text">AI Tutor â€¢ Checking...</span>
            </div>
        </div>
        
        <!-- Right Panel: Chat Interface -->
        <div class="chat-panel">
            <!-- Messages Area -->
            <div class="chat-messages" id="chat-messages">
                <!-- Welcome State -->
                <div class="welcome-state" id="welcome-state">
                    <h2 class="welcome-title">Welcome to Your AI Tutor</h2>
                    <p class="welcome-subtitle">Start a conversation or ask any question to begin learning</p>
                </div>
            </div>
            
            <!-- Input Bar -->
            <div class="chat-input-bar">
                <button class="input-icon-btn" onclick="attachFile()" title="Attach file">
                    <i class="fa-solid fa-paperclip"></i>
                </button>
                
                <button class="input-icon-btn" onclick="toggleVoice()" title="Voice input" id="voice-btn">
                    <i class="fa-solid fa-microphone"></i>
                </button>
                
                <input 
                    type="text" 
                    class="chat-input" 
                    id="chat-input" 
                    placeholder="Type a message..."
                    autocomplete="off"
                    onkeydown="handleKeyPress(event)"
                />
                
                <button class="send-btn" onclick="sendMessage()" title="Send message">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Backend Connection Status
        let isBackendConnected = false;
        const BACKEND_URL = 'http://localhost:5000'; // Change this to your backend URL
        
        async function checkBackendConnection() {
            const statusBadge = document.getElementById('status-badge');
            const statusText = document.getElementById('status-text');
            
            try {
                // Try to ping the backend
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout
                
                const response = await fetch(`${BACKEND_URL}/health`, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    // Backend is connected
                    isBackendConnected = true;
                    statusBadge.classList.remove('offline');
                    statusBadge.classList.add('online');
                    statusText.textContent = 'AI Tutor â€¢ Online';
                } else {
                    throw new Error('Backend not responding');
                }
            } catch (error) {
                // Backend is disconnected
                isBackendConnected = false;
                statusBadge.classList.remove('online');
                statusBadge.classList.add('offline');
                statusText.textContent = 'AI Tutor â€¢ Offline';
                console.log('Backend connection failed:', error.message);
            }
        }
        
        // Check connection every 10 seconds
        setInterval(checkBackendConnection, 10000);
        
        // Custom Notification Functions
        function showNotification(message, title = 'Connection Error') {
            const overlay = document.getElementById('notification-overlay');
            const messageEl = document.getElementById('notification-message');
            const titleEl = document.querySelector('.notification-title');
            
            messageEl.textContent = message;
            titleEl.textContent = title;
            overlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        function closeNotification() {
            const overlay = document.getElementById('notification-overlay');
            overlay.classList.remove('show');
            document.body.style.overflow = '';
        }
        
        // Settings Drawer Functions
        function openSettings() {
            document.getElementById('settings-drawer').classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeSettings() {
            document.getElementById('settings-drawer').classList.remove('open');
            document.body.style.overflow = '';
        }

        // Handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Check if backend is connected
            if (!isBackendConnected) {
                showNotification('Cannot send message: AI Tutor is offline. Please check your connection.');
                return;
            }
            
            // Hide welcome state
            const welcomeState = document.getElementById('welcome-state');
            if (welcomeState) {
                welcomeState.style.display = 'none';
            }
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Simulate AI response (replace with actual backend call)
            setTimeout(() => {
                const response = "I'm here to help! This is a demo response. In production, this would connect to your AI backend.";
                addMessage(response, 'ai');
            }, 1000);
        }

        // Add message to chat
        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message-wrapper ${sender}-message-wrapper`;
            
            const separatorLine = document.createElement('div');
            separatorLine.className = 'message-separator';
            
            const messageContent = document.createElement('div');
            messageContent.className = `chat-message ${sender}-message`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = sender === 'user' 
                ? '<i class="fa-solid fa-user"></i>' 
                : '<i class="fa-solid fa-robot"></i>';
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = text;
            
            if (sender === 'user') {
                messageContent.appendChild(bubble);
                messageContent.appendChild(avatar);
            } else {
                messageContent.appendChild(avatar);
                messageContent.appendChild(bubble);
            }
            
            messageDiv.appendChild(separatorLine);
            messageDiv.appendChild(messageContent);
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Voice input
        let isRecording = false;
        function toggleVoice() {
            const voiceBtn = document.getElementById('voice-btn');
            isRecording = !isRecording;
            
            if (isRecording) {
                voiceBtn.style.color = 'var(--gold)';
                console.log('Voice recording started');
            } else {
                voiceBtn.style.color = '';
                console.log('Voice recording stopped');
            }
        }

        // File attachment
        function attachFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf,.docx,.txt,.jpg,.png';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    addMessage(`ðŸ“Ž Attached: ${file.name}`, 'user');
                }
            };
            input.click();
        }

        // Handle document upload
        function handleDocumentUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const docList = document.querySelector('.doc-list');
                const docItem = document.createElement('div');
                docItem.className = 'doc-item';
                docItem.innerHTML = `
                    <i class="fa-solid fa-file-${file.name.endsWith('.pdf') ? 'pdf' : 'alt'}"></i>
                    <span>${file.name}</span>
                `;
                docList.appendChild(docItem);
                console.log('Document uploaded:', file.name);
                event.target.value = ''; // Reset input
            }
        }

        // Load saved settings and personalize welcome
        window.addEventListener('load', () => {
            // Check backend connection immediately
            checkBackendConnection();
            
            const saved = localStorage.getItem('eduagent-settings');
            if (saved) {
                const settings = JSON.parse(saved);
                console.log('Loaded settings:', settings);
                
                // Personalize welcome message if username exists
                if (settings.username) {
                    const welcomeTitle = document.querySelector('.welcome-title');
                    if (welcomeTitle) {
                        welcomeTitle.textContent = `Hey there, ${settings.username}`;
                    }
                }
            }
        });
    </script>
</body>
</html>
